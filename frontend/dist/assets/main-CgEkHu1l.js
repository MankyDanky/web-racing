import{C as T,V as p,M as y,T as u,Q as E,S as P,a as d,R as I,P as M,b as D,c as k,d as R,e as w,f as j,W as x,g as O,A,D as v,G as N,h as H}from"./GLTFLoader-DfiLd5rB.js";class z{constructor(){this.container=document.getElementById("car-model-container"),this.scene=null,this.camera=null,this.renderer=null,this.car=null,this.isInitialized=!1,this.currentColor=sessionStorage.getItem("carColor")||"red",this.carRotation=0,this.carRotationSpeed=.01,this.init(),this.setupColorChangeListener()}init(){if(!this.container)return;this.scene=new THREE.Scene;const t=new THREE.AmbientLight(16777215,.6);this.scene.add(t);const e=new THREE.DirectionalLight(16777215,1);e.position.set(1,1,1),this.scene.add(e);const s=new THREE.PointLight(16777215,2,50);s.position.set(0,10,5),this.scene.add(s);const i=this.container.clientWidth,a=this.container.clientHeight;this.camera=new THREE.PerspectiveCamera(40,i/a,.1,100),this.camera.position.set(0,3,8),this.camera.lookAt(0,2,0),this.renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!0}),this.renderer.setSize(i,a),this.renderer.setClearColor(0,0),this.renderer.shadowMap.enabled=!0,this.container.appendChild(this.renderer.domElement),this.loadCarModel(this.currentColor),window.addEventListener("resize",this.onWindowResize.bind(this)),this.animate()}loadCarModel(t="red"){const e=new THREE.GLTFLoader;this.car&&(this.scene.remove(this.car),this.car=null),e.load(`/models/car_${t}.glb`,s=>{this.car=s.scene,this.car.position.set(0,2,0),this.car.rotation.y=this.carRotation,this.car.scale.set(8,8,8),this.scene.add(this.car),this.isInitialized=!0,console.log(`Loaded lobby preview car: ${t}`)},void 0,s=>{console.error(`Error loading car_${t}.glb:`,s),t!=="red"&&(console.log("Falling back to red car model"),this.loadCarModel("red"))})}setupColorChangeListener(){const t=document.querySelectorAll(".color-option");if(!t.length){console.warn("No color options found in the DOM");return}t.forEach(e=>{e.addEventListener("click",()=>{const s=e.getAttribute("data-color");s&&s!==this.currentColor&&(console.log(`Changing car preview color to: ${s}`),this.currentColor=s,this.loadCarModel(s))})})}onWindowResize(){if(!this.camera||!this.renderer||!this.container)return;const t=this.container.clientWidth,e=this.container.clientHeight;this.camera.aspect=t/e,this.camera.updateProjectionMatrix(),this.renderer.setSize(t,e)}animate(){requestAnimationFrame(this.animate.bind(this)),this.car&&this.isInitialized&&(this.carRotation+=this.carRotationSpeed,this.car.rotation.y=this.carRotation),this.renderer&&this.scene&&this.camera&&this.renderer.render(this.scene,this.camera)}}document.addEventListener("DOMContentLoaded",()=>{new z});class B{constructor(){this.peer=null,this.connections=[],this.isHost=!1,this.hostId=null,this.playerId=null,this.playerName=`Player_${Math.floor(Math.random()*1e4)}`,this.players=[],this.initUIElements(),this.attachEventListeners(),this.initCarColorCarousel(),this.initPeerJS()}initUIElements(){this.createPartyBtn=document.getElementById("create-party-btn"),this.hostInfo=document.getElementById("host-info"),this.partyCodeDisplay=document.getElementById("party-code"),this.copyCodeBtn=document.getElementById("copy-code-btn"),this.hostStopBtn=document.getElementById("host-stop-btn"),this.playerNameInput=document.getElementById("player-name-input"),this.playBtn=document.getElementById("play-btn"),this.joinCodeInput=document.getElementById("join-code-input"),this.joinPartyBtn=document.getElementById("join-party-btn"),this.joinStatus=document.getElementById("join-status"),this.joinSection=document.querySelector(".join-section"),this.playerList=document.getElementById("player-list"),this.racersTitle=document.querySelector(".right-panel .panel-title"),this.playersContainer=document.querySelector(".players-container"),this.racersTitle.classList.add("hidden"),this.playersContainer.classList.add("hidden"),this.playerNameInput.value=this.playerName}initPeerJS(){this.peer=new Peer,this.peer.on("open",t=>{this.playerId=t,localStorage.setItem("myPlayerId",t),console.log("My peer ID is: "+t)}),this.peer.on("connection",t=>{this.handleIncomingConnection(t)}),this.peer.on("error",t=>{console.error("Peer connection error:",t),t.type==="peer-unavailable"?this.joinStatus.textContent="Could not find that party. Check the code and try again.":this.joinStatus.textContent=`Connection error: ${t.type}`})}attachEventListeners(){this.createPartyBtn.addEventListener("click",()=>{this.createParty()}),this.copyCodeBtn.addEventListener("click",()=>{navigator.clipboard.writeText(this.partyCodeDisplay.textContent).then(()=>{this.copyCodeBtn.textContent="Copied!",setTimeout(()=>this.copyCodeBtn.textContent="Copy",2e3)}).catch(t=>{console.error("Failed to copy: ",t)})}),this.joinPartyBtn.addEventListener("click",()=>{const t=this.joinCodeInput.value.trim().toUpperCase();t?this.joinParty(t):this.joinStatus.textContent="Please enter a party code"}),this.playerNameInput.addEventListener("input",()=>{if(this.playerName=this.playerNameInput.value.trim()||`Player_${Math.floor(Math.random()*1e4)}`,this.players.length>0){const t=this.players.find(e=>e.id===this.playerId);t&&(t.name=this.playerName,this.isHost?this.broadcastToAll({type:"partyState",players:this.players,trackId:"map1"}):this.hostId&&this.sendToHost({type:"playerUpdate",playerId:this.playerId,playerName:this.playerName,playerColor:sessionStorage.getItem("carColor")||"red"})),this.updatePlayerList()}}),this.hostStopBtn.addEventListener("click",()=>{this.isHost&&this.stopHosting()}),this.playBtn.addEventListener("click",()=>{this.playerNameInput.value.trim()&&(this.playerName=this.playerNameInput.value.trim()),this.isHost?(console.log("Starting multiplayer game as host"),this.startMultiplayerGame()):this.hostId?alert("Only the host can start the race. Wait for the host to begin!"):(console.log("Starting single player game"),this.startSinglePlayerGame())})}createParty(){if(this.isHost=!0,this.joinSection.classList.add("hidden"),!this.playerId){this.createPartyBtn.textContent="Initializing...",this.createPartyBtn.disabled=!0;const t=setInterval(()=>{this.playerId&&(clearInterval(t),this.createPartyWithPeerId())},100);return}this.createPartyWithPeerId()}createPartyWithPeerId(){fetch("https://mankydanky.pythonanywhere.com/api/party-codes/create/",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({peer_id:this.playerId})}).then(t=>{if(!t.ok)throw new Error("Failed to create party code");return t.json()}).then(t=>{console.log("Party created with code:",t.code),this.partyCodeDisplay.textContent=t.code,this.hostInfo.classList.remove("hidden"),this.createPartyBtn.classList.add("hidden"),this.racersTitle.classList.remove("hidden"),this.playersContainer.classList.remove("hidden"),this.players=[{id:this.playerId,name:this.playerName,isHost:!0}],this.updatePlayerList(),this.playBtn.classList.remove("disabled")}).catch(t=>{console.error("Error creating party:",t),this.createPartyBtn.textContent="Create Party",this.createPartyBtn.disabled=!1,alert("Error creating party. Please try again.")})}joinParty(t){this.joinStatus.textContent="Looking up party...",fetch(`https://mankydanky.pythonanywhere.com/api/party-codes/lookup/${t}/`).then(e=>{if(!e.ok)throw new Error("Party not found");return e.json()}).then(e=>{const s=e.peer_id;this.joinStatus.textContent="Connecting to party...";const i=this.peer.connect(s);i.on("open",()=>{this.hostId=s,this.racersTitle.classList.remove("hidden"),this.playersContainer.classList.remove("hidden"),this.joinSection.classList.add("hidden"),i.send({type:"joinRequest",playerId:this.playerId,playerName:this.playerName,playerColor:sessionStorage.getItem("carColor")||"red"}),this.connections.push({peerId:s,connection:i}),i.on("data",a=>{this.handleMessage(i,a)}),this.joinStatus.textContent="Connected to party!"}),i.on("error",a=>{console.error("Connection error:",a),this.joinStatus.textContent="Error connecting to host."})}).catch(e=>{console.error("Error looking up party:",e),this.joinStatus.textContent="Could not find that party. Check the code and try again."})}leaveParty(){if(!this.hostId)return;const t=this.connections.find(e=>e.peerId===this.hostId);if(t&&t.connection){t.connection.send({type:"playerLeft",playerId:this.playerId});try{t.connection.close()}catch(e){console.log("Error closing connection:",e)}}this.hostId=null,this.connections=[],this.players=[],this.racersTitle.classList.add("hidden"),this.playersContainer.classList.add("hidden"),this.joinSection.classList.remove("hidden"),this.joinStatus.textContent="",this.joinCodeInput.value="",this.updatePlayerList()}handleIncomingConnection(t){console.log("Incoming connection from:",t.peer),this.connections.push({peerId:t.peer,connection:t}),t.on("data",e=>{this.handleMessage(t,e)}),t.on("close",()=>{this.removePlayer(t.peer)})}handleMessage(t,e){switch(console.log("Received message:",e),e.type){case"joinRequest":if(this.isHost){const s={id:e.playerId,name:e.playerName,isHost:!1,playerColor:e.playerColor||"red"};this.players.push(s),this.updatePlayerList(),t.send({type:"partyState",players:this.players,trackId:"map1"}),this.broadcastToAll({type:"playerJoined",player:s},t.peer)}break;case"partyState":this.players=e.players,this.updatePlayerList();break;case"playerJoined":this.players.push(e.player),this.updatePlayerList();break;case"startGame":sessionStorage.setItem("gameConfig",JSON.stringify(e)),window.location.href="game.html";break;case"partyEnded":alert("The host has ended the party."),this.racersTitle.classList.add("hidden"),this.playersContainer.classList.add("hidden"),window.location.reload();break;case"playerUpdate":if(this.isHost){const s=this.players.findIndex(i=>i.id===e.playerId);s!==-1&&(this.players[s].name=e.playerName,this.players[s].playerColor=e.playerColor,this.updatePlayerList(),this.broadcastToAll({type:"partyState",players:this.players,trackId:"map1"}))}break;case"playerLeft":this.isHost&&(this.removePlayer(e.playerId),this.broadcastToAll({type:"partyState",players:this.players,trackId:"map1"}));break}}broadcastToAll(t,e=null){console.log("Broadcasting message:",t),this.connections.forEach(s=>{s.peerId!==e&&(console.log("Broadcasting message to:",s.peerId),s.connection.send(t))})}updatePlayerList(){if(this.playerList.innerHTML="",this.players.length===0){const t=document.createElement("li");t.textContent="No players in party yet",t.classList.add("no-players"),this.playerList.appendChild(t)}else this.players.forEach(t=>{const e=document.createElement("li");if(e.textContent=t.name,t.isHost){const s=document.createElement("span");s.textContent="HOST",s.classList.add("host-badge"),e.appendChild(s)}else if(t.id===this.playerId&&!this.isHost){const s=document.createElement("button");s.textContent="EXIT",s.classList.add("exit-button"),s.addEventListener("click",()=>this.leaveParty()),e.appendChild(s)}this.playerList.appendChild(e)})}removePlayer(t){this.players=this.players.filter(e=>e.id!==t),this.updatePlayerList(),this.connections=this.connections.filter(e=>e.peerId!==t),this.isHost&&this.broadcastToAll({type:"partyState",players:this.players,trackId:"map1"})}startMultiplayerGame(){if(console.log("Creating multiplayer game with players:",this.players),this.players.length===0)this.players=[{id:this.playerId,name:this.playerName,isHost:!0,playerColor:sessionStorage.getItem("carColor")||"red"}];else{const e=this.players.findIndex(s=>s.id===this.playerId);e!==-1&&(this.players[e].playerColor=sessionStorage.getItem("carColor")||"red")}const t={type:"startGame",trackId:"map1",players:this.players,multiplayer:!0};this.broadcastToAll({type:"startGame",trackId:"map1",players:this.players,multiplayer:!0}),sessionStorage.setItem("gameConfig",JSON.stringify(t)),console.log("Game config saved:",t),console.log("Navigating to game.html"),setTimeout(()=>{this.connections.forEach(e=>{try{e.connection.close()}catch(s){console.log("Error closing connection:",s)}}),this.peer&&this.peer.disconnect(),window.location.href="game.html"},200)}startSinglePlayerGame(){const t={type:"startGame",trackId:"map1",players:[{id:this.playerId||"solo-player",name:this.playerName,isHost:!0}],isSinglePlayer:!0};sessionStorage.setItem("gameConfig",JSON.stringify(t)),window.location.href="game.html"}stopHosting(){this.broadcastToAll({type:"partyEnded",message:"Host has ended the party"}),this.connections.forEach(t=>{try{t.connection.close()}catch(e){console.log("Error closing connection:",e)}}),this.connections=[],this.players=[],this.isHost=!1,this.hostInfo.classList.add("hidden"),this.createPartyBtn.classList.remove("hidden"),this.createPartyBtn.disabled=!1,this.joinSection.classList.remove("hidden"),this.racersTitle.classList.add("hidden"),this.playersContainer.classList.add("hidden"),this.updatePlayerList(),this.peer&&(this.peer.disconnect(),this.initPeerJS())}initCarColorCarousel(){const t=document.querySelectorAll(".color-option"),e=sessionStorage.getItem("carColor")||"red";let s=!1;t.forEach(i=>{i.getAttribute("data-color")===e&&(t.forEach(r=>r.classList.remove("active")),i.classList.add("active"),s=!0),i.addEventListener("click",()=>{t.forEach(c=>c.classList.remove("active")),i.classList.add("active");const r=i.getAttribute("data-color");sessionStorage.setItem("carColor",r),this.hostId&&!this.isHost&&this.sendToHost({type:"playerUpdate",playerId:this.playerId,playerName:this.playerName,playerColor:r})})}),s||(sessionStorage.setItem("carColor","red"),t[0].classList.add("active"))}setupColorChangeListener(){const t=document.querySelectorAll(".color-option");t.forEach(e=>{e.addEventListener("click",()=>{t.forEach(i=>i.classList.remove("active")),e.classList.add("active");const s=e.getAttribute("data-color");sessionStorage.setItem("carColor",s),this.hostId&&!this.isHost&&this.sendToHost({type:"playerUpdate",playerId:this.playerId,playerName:this.playerName,playerColor:s})})})}sendToHost(t){const e=this.connections.find(s=>s.peerId===this.hostId);e&&e.connection?(console.log("Sending update to host:",t),e.connection.send(t)):console.error("No host connection found")}}document.addEventListener("DOMContentLoaded",()=>{new B});const C={type:"change"},g={type:"start"},L={type:"end"},f=new I,S=new M,U=Math.cos(70*D.DEG2RAD),h=new p,l=2*Math.PI,n={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6},_=1e-6;class Y extends T{constructor(t,e=null){super(t,e),this.state=n.NONE,this.target=new p,this.cursor=new p,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minTargetRadius=0,this.maxTargetRadius=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.05,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.keyRotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.zoomToCursor=!1,this.autoRotate=!1,this.autoRotateSpeed=2,this.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"},this.mouseButtons={LEFT:y.ROTATE,MIDDLE:y.DOLLY,RIGHT:y.PAN},this.touches={ONE:u.ROTATE,TWO:u.DOLLY_PAN},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this._domElementKeyEvents=null,this._lastPosition=new p,this._lastQuaternion=new E,this._lastTargetPosition=new p,this._quat=new E().setFromUnitVectors(t.up,new p(0,1,0)),this._quatInverse=this._quat.clone().invert(),this._spherical=new P,this._sphericalDelta=new P,this._scale=1,this._panOffset=new p,this._rotateStart=new d,this._rotateEnd=new d,this._rotateDelta=new d,this._panStart=new d,this._panEnd=new d,this._panDelta=new d,this._dollyStart=new d,this._dollyEnd=new d,this._dollyDelta=new d,this._dollyDirection=new p,this._mouse=new d,this._performCursorZoom=!1,this._pointers=[],this._pointerPositions={},this._controlActive=!1,this._onPointerMove=W.bind(this),this._onPointerDown=Z.bind(this),this._onPointerUp=K.bind(this),this._onContextMenu=$.bind(this),this._onMouseWheel=G.bind(this),this._onKeyDown=q.bind(this),this._onTouchStart=V.bind(this),this._onTouchMove=J.bind(this),this._onMouseDown=F.bind(this),this._onMouseMove=X.bind(this),this._interceptControlDown=Q.bind(this),this._interceptControlUp=tt.bind(this),this.domElement!==null&&this.connect(this.domElement),this.update()}connect(t){super.connect(t),this.domElement.addEventListener("pointerdown",this._onPointerDown),this.domElement.addEventListener("pointercancel",this._onPointerUp),this.domElement.addEventListener("contextmenu",this._onContextMenu),this.domElement.addEventListener("wheel",this._onMouseWheel,{passive:!1}),this.domElement.getRootNode().addEventListener("keydown",this._interceptControlDown,{passive:!0,capture:!0}),this.domElement.style.touchAction="none"}disconnect(){this.domElement.removeEventListener("pointerdown",this._onPointerDown),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.domElement.removeEventListener("pointercancel",this._onPointerUp),this.domElement.removeEventListener("wheel",this._onMouseWheel),this.domElement.removeEventListener("contextmenu",this._onContextMenu),this.stopListenToKeyEvents(),this.domElement.getRootNode().removeEventListener("keydown",this._interceptControlDown,{capture:!0}),this.domElement.style.touchAction="auto"}dispose(){this.disconnect()}getPolarAngle(){return this._spherical.phi}getAzimuthalAngle(){return this._spherical.theta}getDistance(){return this.object.position.distanceTo(this.target)}listenToKeyEvents(t){t.addEventListener("keydown",this._onKeyDown),this._domElementKeyEvents=t}stopListenToKeyEvents(){this._domElementKeyEvents!==null&&(this._domElementKeyEvents.removeEventListener("keydown",this._onKeyDown),this._domElementKeyEvents=null)}saveState(){this.target0.copy(this.target),this.position0.copy(this.object.position),this.zoom0=this.object.zoom}reset(){this.target.copy(this.target0),this.object.position.copy(this.position0),this.object.zoom=this.zoom0,this.object.updateProjectionMatrix(),this.dispatchEvent(C),this.update(),this.state=n.NONE}update(t=null){const e=this.object.position;h.copy(e).sub(this.target),h.applyQuaternion(this._quat),this._spherical.setFromVector3(h),this.autoRotate&&this.state===n.NONE&&this._rotateLeft(this._getAutoRotationAngle(t)),this.enableDamping?(this._spherical.theta+=this._sphericalDelta.theta*this.dampingFactor,this._spherical.phi+=this._sphericalDelta.phi*this.dampingFactor):(this._spherical.theta+=this._sphericalDelta.theta,this._spherical.phi+=this._sphericalDelta.phi);let s=this.minAzimuthAngle,i=this.maxAzimuthAngle;isFinite(s)&&isFinite(i)&&(s<-Math.PI?s+=l:s>Math.PI&&(s-=l),i<-Math.PI?i+=l:i>Math.PI&&(i-=l),s<=i?this._spherical.theta=Math.max(s,Math.min(i,this._spherical.theta)):this._spherical.theta=this._spherical.theta>(s+i)/2?Math.max(s,this._spherical.theta):Math.min(i,this._spherical.theta)),this._spherical.phi=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,this._spherical.phi)),this._spherical.makeSafe(),this.enableDamping===!0?this.target.addScaledVector(this._panOffset,this.dampingFactor):this.target.add(this._panOffset),this.target.sub(this.cursor),this.target.clampLength(this.minTargetRadius,this.maxTargetRadius),this.target.add(this.cursor);let a=!1;if(this.zoomToCursor&&this._performCursorZoom||this.object.isOrthographicCamera)this._spherical.radius=this._clampDistance(this._spherical.radius);else{const r=this._spherical.radius;this._spherical.radius=this._clampDistance(this._spherical.radius*this._scale),a=r!=this._spherical.radius}if(h.setFromSpherical(this._spherical),h.applyQuaternion(this._quatInverse),e.copy(this.target).add(h),this.object.lookAt(this.target),this.enableDamping===!0?(this._sphericalDelta.theta*=1-this.dampingFactor,this._sphericalDelta.phi*=1-this.dampingFactor,this._panOffset.multiplyScalar(1-this.dampingFactor)):(this._sphericalDelta.set(0,0,0),this._panOffset.set(0,0,0)),this.zoomToCursor&&this._performCursorZoom){let r=null;if(this.object.isPerspectiveCamera){const c=h.length();r=this._clampDistance(c*this._scale);const m=c-r;this.object.position.addScaledVector(this._dollyDirection,m),this.object.updateMatrixWorld(),a=!!m}else if(this.object.isOrthographicCamera){const c=new p(this._mouse.x,this._mouse.y,0);c.unproject(this.object);const m=this.object.zoom;this.object.zoom=Math.max(this.minZoom,Math.min(this.maxZoom,this.object.zoom/this._scale)),this.object.updateProjectionMatrix(),a=m!==this.object.zoom;const b=new p(this._mouse.x,this._mouse.y,0);b.unproject(this.object),this.object.position.sub(b).add(c),this.object.updateMatrixWorld(),r=h.length()}else console.warn("WARNING: OrbitControls.js encountered an unknown camera type - zoom to cursor disabled."),this.zoomToCursor=!1;r!==null&&(this.screenSpacePanning?this.target.set(0,0,-1).transformDirection(this.object.matrix).multiplyScalar(r).add(this.object.position):(f.origin.copy(this.object.position),f.direction.set(0,0,-1).transformDirection(this.object.matrix),Math.abs(this.object.up.dot(f.direction))<U?this.object.lookAt(this.target):(S.setFromNormalAndCoplanarPoint(this.object.up,this.target),f.intersectPlane(S,this.target))))}else if(this.object.isOrthographicCamera){const r=this.object.zoom;this.object.zoom=Math.max(this.minZoom,Math.min(this.maxZoom,this.object.zoom/this._scale)),r!==this.object.zoom&&(this.object.updateProjectionMatrix(),a=!0)}return this._scale=1,this._performCursorZoom=!1,a||this._lastPosition.distanceToSquared(this.object.position)>_||8*(1-this._lastQuaternion.dot(this.object.quaternion))>_||this._lastTargetPosition.distanceToSquared(this.target)>_?(this.dispatchEvent(C),this._lastPosition.copy(this.object.position),this._lastQuaternion.copy(this.object.quaternion),this._lastTargetPosition.copy(this.target),!0):!1}_getAutoRotationAngle(t){return t!==null?l/60*this.autoRotateSpeed*t:l/60/60*this.autoRotateSpeed}_getZoomScale(t){const e=Math.abs(t*.01);return Math.pow(.95,this.zoomSpeed*e)}_rotateLeft(t){this._sphericalDelta.theta-=t}_rotateUp(t){this._sphericalDelta.phi-=t}_panLeft(t,e){h.setFromMatrixColumn(e,0),h.multiplyScalar(-t),this._panOffset.add(h)}_panUp(t,e){this.screenSpacePanning===!0?h.setFromMatrixColumn(e,1):(h.setFromMatrixColumn(e,0),h.crossVectors(this.object.up,h)),h.multiplyScalar(t),this._panOffset.add(h)}_pan(t,e){const s=this.domElement;if(this.object.isPerspectiveCamera){const i=this.object.position;h.copy(i).sub(this.target);let a=h.length();a*=Math.tan(this.object.fov/2*Math.PI/180),this._panLeft(2*t*a/s.clientHeight,this.object.matrix),this._panUp(2*e*a/s.clientHeight,this.object.matrix)}else this.object.isOrthographicCamera?(this._panLeft(t*(this.object.right-this.object.left)/this.object.zoom/s.clientWidth,this.object.matrix),this._panUp(e*(this.object.top-this.object.bottom)/this.object.zoom/s.clientHeight,this.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),this.enablePan=!1)}_dollyOut(t){this.object.isPerspectiveCamera||this.object.isOrthographicCamera?this._scale/=t:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),this.enableZoom=!1)}_dollyIn(t){this.object.isPerspectiveCamera||this.object.isOrthographicCamera?this._scale*=t:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),this.enableZoom=!1)}_updateZoomParameters(t,e){if(!this.zoomToCursor)return;this._performCursorZoom=!0;const s=this.domElement.getBoundingClientRect(),i=t-s.left,a=e-s.top,r=s.width,c=s.height;this._mouse.x=i/r*2-1,this._mouse.y=-(a/c)*2+1,this._dollyDirection.set(this._mouse.x,this._mouse.y,1).unproject(this.object).sub(this.object.position).normalize()}_clampDistance(t){return Math.max(this.minDistance,Math.min(this.maxDistance,t))}_handleMouseDownRotate(t){this._rotateStart.set(t.clientX,t.clientY)}_handleMouseDownDolly(t){this._updateZoomParameters(t.clientX,t.clientX),this._dollyStart.set(t.clientX,t.clientY)}_handleMouseDownPan(t){this._panStart.set(t.clientX,t.clientY)}_handleMouseMoveRotate(t){this._rotateEnd.set(t.clientX,t.clientY),this._rotateDelta.subVectors(this._rotateEnd,this._rotateStart).multiplyScalar(this.rotateSpeed);const e=this.domElement;this._rotateLeft(l*this._rotateDelta.x/e.clientHeight),this._rotateUp(l*this._rotateDelta.y/e.clientHeight),this._rotateStart.copy(this._rotateEnd),this.update()}_handleMouseMoveDolly(t){this._dollyEnd.set(t.clientX,t.clientY),this._dollyDelta.subVectors(this._dollyEnd,this._dollyStart),this._dollyDelta.y>0?this._dollyOut(this._getZoomScale(this._dollyDelta.y)):this._dollyDelta.y<0&&this._dollyIn(this._getZoomScale(this._dollyDelta.y)),this._dollyStart.copy(this._dollyEnd),this.update()}_handleMouseMovePan(t){this._panEnd.set(t.clientX,t.clientY),this._panDelta.subVectors(this._panEnd,this._panStart).multiplyScalar(this.panSpeed),this._pan(this._panDelta.x,this._panDelta.y),this._panStart.copy(this._panEnd),this.update()}_handleMouseWheel(t){this._updateZoomParameters(t.clientX,t.clientY),t.deltaY<0?this._dollyIn(this._getZoomScale(t.deltaY)):t.deltaY>0&&this._dollyOut(this._getZoomScale(t.deltaY)),this.update()}_handleKeyDown(t){let e=!1;switch(t.code){case this.keys.UP:t.ctrlKey||t.metaKey||t.shiftKey?this.enableRotate&&this._rotateUp(l*this.keyRotateSpeed/this.domElement.clientHeight):this.enablePan&&this._pan(0,this.keyPanSpeed),e=!0;break;case this.keys.BOTTOM:t.ctrlKey||t.metaKey||t.shiftKey?this.enableRotate&&this._rotateUp(-l*this.keyRotateSpeed/this.domElement.clientHeight):this.enablePan&&this._pan(0,-this.keyPanSpeed),e=!0;break;case this.keys.LEFT:t.ctrlKey||t.metaKey||t.shiftKey?this.enableRotate&&this._rotateLeft(l*this.keyRotateSpeed/this.domElement.clientHeight):this.enablePan&&this._pan(this.keyPanSpeed,0),e=!0;break;case this.keys.RIGHT:t.ctrlKey||t.metaKey||t.shiftKey?this.enableRotate&&this._rotateLeft(-l*this.keyRotateSpeed/this.domElement.clientHeight):this.enablePan&&this._pan(-this.keyPanSpeed,0),e=!0;break}e&&(t.preventDefault(),this.update())}_handleTouchStartRotate(t){if(this._pointers.length===1)this._rotateStart.set(t.pageX,t.pageY);else{const e=this._getSecondPointerPosition(t),s=.5*(t.pageX+e.x),i=.5*(t.pageY+e.y);this._rotateStart.set(s,i)}}_handleTouchStartPan(t){if(this._pointers.length===1)this._panStart.set(t.pageX,t.pageY);else{const e=this._getSecondPointerPosition(t),s=.5*(t.pageX+e.x),i=.5*(t.pageY+e.y);this._panStart.set(s,i)}}_handleTouchStartDolly(t){const e=this._getSecondPointerPosition(t),s=t.pageX-e.x,i=t.pageY-e.y,a=Math.sqrt(s*s+i*i);this._dollyStart.set(0,a)}_handleTouchStartDollyPan(t){this.enableZoom&&this._handleTouchStartDolly(t),this.enablePan&&this._handleTouchStartPan(t)}_handleTouchStartDollyRotate(t){this.enableZoom&&this._handleTouchStartDolly(t),this.enableRotate&&this._handleTouchStartRotate(t)}_handleTouchMoveRotate(t){if(this._pointers.length==1)this._rotateEnd.set(t.pageX,t.pageY);else{const s=this._getSecondPointerPosition(t),i=.5*(t.pageX+s.x),a=.5*(t.pageY+s.y);this._rotateEnd.set(i,a)}this._rotateDelta.subVectors(this._rotateEnd,this._rotateStart).multiplyScalar(this.rotateSpeed);const e=this.domElement;this._rotateLeft(l*this._rotateDelta.x/e.clientHeight),this._rotateUp(l*this._rotateDelta.y/e.clientHeight),this._rotateStart.copy(this._rotateEnd)}_handleTouchMovePan(t){if(this._pointers.length===1)this._panEnd.set(t.pageX,t.pageY);else{const e=this._getSecondPointerPosition(t),s=.5*(t.pageX+e.x),i=.5*(t.pageY+e.y);this._panEnd.set(s,i)}this._panDelta.subVectors(this._panEnd,this._panStart).multiplyScalar(this.panSpeed),this._pan(this._panDelta.x,this._panDelta.y),this._panStart.copy(this._panEnd)}_handleTouchMoveDolly(t){const e=this._getSecondPointerPosition(t),s=t.pageX-e.x,i=t.pageY-e.y,a=Math.sqrt(s*s+i*i);this._dollyEnd.set(0,a),this._dollyDelta.set(0,Math.pow(this._dollyEnd.y/this._dollyStart.y,this.zoomSpeed)),this._dollyOut(this._dollyDelta.y),this._dollyStart.copy(this._dollyEnd);const r=(t.pageX+e.x)*.5,c=(t.pageY+e.y)*.5;this._updateZoomParameters(r,c)}_handleTouchMoveDollyPan(t){this.enableZoom&&this._handleTouchMoveDolly(t),this.enablePan&&this._handleTouchMovePan(t)}_handleTouchMoveDollyRotate(t){this.enableZoom&&this._handleTouchMoveDolly(t),this.enableRotate&&this._handleTouchMoveRotate(t)}_addPointer(t){this._pointers.push(t.pointerId)}_removePointer(t){delete this._pointerPositions[t.pointerId];for(let e=0;e<this._pointers.length;e++)if(this._pointers[e]==t.pointerId){this._pointers.splice(e,1);return}}_isTrackingPointer(t){for(let e=0;e<this._pointers.length;e++)if(this._pointers[e]==t.pointerId)return!0;return!1}_trackPointer(t){let e=this._pointerPositions[t.pointerId];e===void 0&&(e=new d,this._pointerPositions[t.pointerId]=e),e.set(t.pageX,t.pageY)}_getSecondPointerPosition(t){const e=t.pointerId===this._pointers[0]?this._pointers[1]:this._pointers[0];return this._pointerPositions[e]}_customWheelEvent(t){const e=t.deltaMode,s={clientX:t.clientX,clientY:t.clientY,deltaY:t.deltaY};switch(e){case 1:s.deltaY*=16;break;case 2:s.deltaY*=100;break}return t.ctrlKey&&!this._controlActive&&(s.deltaY*=10),s}}function Z(o){this.enabled!==!1&&(this._pointers.length===0&&(this.domElement.setPointerCapture(o.pointerId),this.domElement.addEventListener("pointermove",this._onPointerMove),this.domElement.addEventListener("pointerup",this._onPointerUp)),!this._isTrackingPointer(o)&&(this._addPointer(o),o.pointerType==="touch"?this._onTouchStart(o):this._onMouseDown(o)))}function W(o){this.enabled!==!1&&(o.pointerType==="touch"?this._onTouchMove(o):this._onMouseMove(o))}function K(o){switch(this._removePointer(o),this._pointers.length){case 0:this.domElement.releasePointerCapture(o.pointerId),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.dispatchEvent(L),this.state=n.NONE;break;case 1:const t=this._pointers[0],e=this._pointerPositions[t];this._onTouchStart({pointerId:t,pageX:e.x,pageY:e.y});break}}function F(o){let t;switch(o.button){case 0:t=this.mouseButtons.LEFT;break;case 1:t=this.mouseButtons.MIDDLE;break;case 2:t=this.mouseButtons.RIGHT;break;default:t=-1}switch(t){case y.DOLLY:if(this.enableZoom===!1)return;this._handleMouseDownDolly(o),this.state=n.DOLLY;break;case y.ROTATE:if(o.ctrlKey||o.metaKey||o.shiftKey){if(this.enablePan===!1)return;this._handleMouseDownPan(o),this.state=n.PAN}else{if(this.enableRotate===!1)return;this._handleMouseDownRotate(o),this.state=n.ROTATE}break;case y.PAN:if(o.ctrlKey||o.metaKey||o.shiftKey){if(this.enableRotate===!1)return;this._handleMouseDownRotate(o),this.state=n.ROTATE}else{if(this.enablePan===!1)return;this._handleMouseDownPan(o),this.state=n.PAN}break;default:this.state=n.NONE}this.state!==n.NONE&&this.dispatchEvent(g)}function X(o){switch(this.state){case n.ROTATE:if(this.enableRotate===!1)return;this._handleMouseMoveRotate(o);break;case n.DOLLY:if(this.enableZoom===!1)return;this._handleMouseMoveDolly(o);break;case n.PAN:if(this.enablePan===!1)return;this._handleMouseMovePan(o);break}}function G(o){this.enabled===!1||this.enableZoom===!1||this.state!==n.NONE||(o.preventDefault(),this.dispatchEvent(g),this._handleMouseWheel(this._customWheelEvent(o)),this.dispatchEvent(L))}function q(o){this.enabled!==!1&&this._handleKeyDown(o)}function V(o){switch(this._trackPointer(o),this._pointers.length){case 1:switch(this.touches.ONE){case u.ROTATE:if(this.enableRotate===!1)return;this._handleTouchStartRotate(o),this.state=n.TOUCH_ROTATE;break;case u.PAN:if(this.enablePan===!1)return;this._handleTouchStartPan(o),this.state=n.TOUCH_PAN;break;default:this.state=n.NONE}break;case 2:switch(this.touches.TWO){case u.DOLLY_PAN:if(this.enableZoom===!1&&this.enablePan===!1)return;this._handleTouchStartDollyPan(o),this.state=n.TOUCH_DOLLY_PAN;break;case u.DOLLY_ROTATE:if(this.enableZoom===!1&&this.enableRotate===!1)return;this._handleTouchStartDollyRotate(o),this.state=n.TOUCH_DOLLY_ROTATE;break;default:this.state=n.NONE}break;default:this.state=n.NONE}this.state!==n.NONE&&this.dispatchEvent(g)}function J(o){switch(this._trackPointer(o),this.state){case n.TOUCH_ROTATE:if(this.enableRotate===!1)return;this._handleTouchMoveRotate(o),this.update();break;case n.TOUCH_PAN:if(this.enablePan===!1)return;this._handleTouchMovePan(o),this.update();break;case n.TOUCH_DOLLY_PAN:if(this.enableZoom===!1&&this.enablePan===!1)return;this._handleTouchMoveDollyPan(o),this.update();break;case n.TOUCH_DOLLY_ROTATE:if(this.enableZoom===!1&&this.enableRotate===!1)return;this._handleTouchMoveDollyRotate(o),this.update();break;default:this.state=n.NONE}}function $(o){this.enabled!==!1&&o.preventDefault()}function Q(o){o.key==="Control"&&(this._controlActive=!0,this.domElement.getRootNode().addEventListener("keyup",this._interceptControlUp,{passive:!0,capture:!0}))}function tt(o){o.key==="Control"&&(this._controlActive=!1,this.domElement.getRootNode().removeEventListener("keyup",this._interceptControlUp,{passive:!0,capture:!0}))}class et{constructor(){this.scene=null,this.camera=null,this.renderer=null,this.controls=null,this.models={},this.clock=new k,this.init()}init(){this.scene=new R,this.scene.background=new w(6737151),this.camera=new j(60,window.innerWidth/window.innerHeight,.1,1e3),this.camera.position.set(0,10,40),this.camera.lookAt(0,0,0),this.renderer=new x({antialias:!0,alpha:!1}),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.physicallyCorrectLights=!0,this.renderer.outputEncoding=void 0,this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=O;const t=this.renderer.domElement;t.id="background-canvas",t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.width="100%",t.style.height="100%",t.style.zIndex="-1",document.body.insertBefore(t,document.body.firstChild),this.controls=new Y(this.camera,t),this.controls.enableDamping=!0,this.controls.dampingFactor=.05,this.controls.enableZoom=!1,this.controls.enablePan=!1,this.controls.autoRotate=!0,this.controls.autoRotateSpeed=.5,this.setupLights(),this.loadModels(),window.addEventListener("resize",this.onWindowResize.bind(this)),this.animate()}setupLights(){const t=new A(16777215,1.5);this.scene.add(t);const e=new v(16777215,3.5);e.position.set(50,100,50),e.castShadow=!0,e.shadow.mapSize.width=2048,e.shadow.mapSize.height=2048,e.shadow.camera.near=.5,e.shadow.camera.far=500,e.shadow.camera.left=-100,e.shadow.camera.right=100,e.shadow.camera.top=100,e.shadow.camera.bottom=-100,this.scene.add(e)}loadModels(){const t=new N;t.load("/models/maps/map1/track.glb",e=>{const s=e.scene;s.traverse(i=>{i.isMesh&&(i.receiveShadow=!1,i.castShadow=!1)}),this.models.track=s,this.scene.add(s)}),t.load("/models/maps/map1/gates.glb",e=>{const s=e.scene;s.traverse(i=>{i.isMesh&&(i.castShadow=!1,i.receiveShadow=!1)}),this.models.gates=s,this.scene.add(s)}),t.load("/models/maps/map1/decorations.glb",e=>{const s=e.scene;console.log("Decorations model:",s),s.traverse(i=>{if(i.isMesh){if(console.log("Mesh found:",i.name,"Material type:",i.material?i.material.type:"none"),i.material){const a=i.material,r=a.color?a.color.clone():new w(16777215),c=a.map,m=new H({color:r,map:c,metalness:.1,roughness:.8});i.material=m,i.material.needsUpdate=!0}i.castShadow=!1,i.receiveShadow=!1}}),this.models.decorations=s,this.scene.add(s),setTimeout(()=>{console.log("Forcing extra renders to update materials");for(let i=0;i<3;i++)this.renderer.render(this.scene,this.camera)},100)})}onWindowResize(){this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix(),this.renderer.setSize(window.innerWidth,window.innerHeight)}animate(){requestAnimationFrame(this.animate.bind(this)),this.clock.getDelta(),this.controls.update(),this.renderer.render(this.scene,this.camera)}}document.addEventListener("DOMContentLoaded",()=>{window.lobbyBackground=new et});
